<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - UPI Money Bank</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --primary:#0066cc;
      --secondary:#ff9900;
      --accent:#6633cc;
      --success:#28a745;
      --danger:#dc3545;
    }

    body {font-family:Arial,sans-serif;margin:0;background:#f0f8ff;}
    header {background:var(--primary);color:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;}
    .piggy-icon{font-size:32px;color:#ffd700}
    .container{padding:20px;max-width:1200px;margin:auto}

    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
    .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08)}

    .summary-card{text-align:center;border-top:5px solid var(--primary)}
    .amount{font-size:2.2rem;font-weight:bold;color:var(--primary)}

    .actions{display:grid;grid-template-columns:repeat(2,1fr);gap:15px}
    .action-btn{background:var(--primary);color:#fff;border:none;padding:12px;border-radius:12px;cursor:pointer}
    .action-btn:hover{background:var(--accent)}
    .emergency-btn{background:var(--danger)}

    h2{color:var(--primary);margin:30px 0}

    .goal-card{background:#fff;border-radius:12px;padding:20px;margin:15px 0;border-left:5px solid var(--primary)}
    .sponsored{border-left:5px solid var(--secondary)}
    .sponsor-badge{background:var(--secondary);color:#fff;padding:4px 10px;border-radius:20px;font-size:12px}

    .progress-bar{height:12px;background:#e9ecef;border-radius:10px;margin:10px 0}
    .progress{height:100%;background:linear-gradient(to right,var(--primary),var(--accent))}

    /* FIXED: native interactive button */
    .break-glass-btn{
      position:fixed;
      bottom:30px;
      right:30px;
      width:70px;
      height:70px;
      background:var(--danger);
      border:none;
      border-radius:50%;
      color:#fff;
      font-size:24px;
      cursor:pointer;
      z-index:100;
    }

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center}
    .modal-content{background:#fff;padding:30px;border-radius:16px;max-width:500px;width:90%}
  </style>
</head>

<body>
<header>
  <div>
    <i class="fas fa-piggy-bank piggy-icon"></i>
    <strong>UPI Piggy Bank</strong>
  </div>
  <div>
    <span id="user-name"></span>
    <img id="profile-picture" src="https://ui-avatars.com/api/?name=User" width="40">
  </div>
</header>

<div class="container">
  <div class="dashboard-grid">
    <div class="card summary-card">
      <h3>Total Savings</h3>
      <div id="total-savings" class="amount">₹0</div>
      <p id="total-goals">Across 0 goals</p>
    </div>

    <div class="card">
      <h3>Quick Actions</h3>
      <div class="actions">
        <button class="action-btn" onclick="openModal('addGoal')">Add Goal</button>
        <button class="action-btn" onclick="openModal('addAccount')">Add Account</button>
        <button class="action-btn" onclick="openPayment()">Add Money</button>
        <button class="action-btn emergency-btn" onclick="openModal('emergency')">Emergency</button>
      </div>
    </div>
  </div>

  <h2>Your Goals</h2>
  <div id="goals-list"><p>Loading goals...</p></div>

  <h2>Sponsored Goals <span class="sponsor-badge">Offers</span></h2>
  <div id="sponsored-goals-list"><p>Loading sponsored goals...</p></div>
</div>

<!-- FIXED: native button instead of div -->
<button
  class="break-glass-btn"
  onclick="openModal('emergency')"
  aria-label="Emergency cash withdrawal">
  <i class="fas fa-first-aid"></i>
</button>

<script>
  function openModal(id){
    document.getElementById(id).style.display='flex';
  }
  function closeModal(id){
    document.getElementById(id).style.display='none';
  }

  globalThis.addEventListener('click', e=>{
    if(e.target.classList.contains('modal')){
      e.target.style.display='none';
    }
  });

  async function loadUserProfile(){
    try{
      const res=await fetch('/profile');
      const data=await res.json();
      if(data.success){
        document.getElementById('user-name').textContent =
          data.user.full_name || data.user.username;
      }
    }catch(e){console.error(e);}
  }

  async function loadGoals(){
    const list=document.getElementById('goals-list');
    try{
      const res=await fetch('/goals');
      const data=await res.json();
      list.innerHTML='';
      if(data.success){
        let total=0;
        data.goals.forEach(g=>{
          total+=Number(g.current_amount)||0;
          const div=document.createElement('div');
          div.className='goal-card';
          div.innerHTML=`<h3>${g.goal_name}</h3>`;
          list.appendChild(div);
        });
        document.getElementById('total-savings').textContent=`₹${total}`;
      }
    }catch(e){console.error(e);}
  }

  async function loadSponsoredGoals(){
    try{
      const res=await fetch('/sponsored-goals');
      const data=await res.json();
      document.getElementById('sponsored-goals-list').innerHTML =
        data.success ? '' : '<p>No sponsored goals</p>';
    }catch(e){console.error(e);}
  }

  function openPayment(){
    alert('Select a goal first');
  }

  /* INIT – correct for non-module scripts */
  loadUserProfile();
  loadGoals();
  loadSponsoredGoals();
</script>
</body>
</html>
